

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Upgrading Your Network Components &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Chaincode Tutorials 链码指南" href="chaincode.html" />
    <link rel="prev" title="Adding an Org to a Channel" href="channel_update_tutorial.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
<br>
<a href="https://chat.hyperledger.org">Rocket Chat</a>  <a href="https://jenkins.hyperledger.org/">CI</a>
<a href="http://stackoverflow.com/questions/tagged/hyperledger-fabric">StackOverflow</a>
<br>
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
  <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">欢迎来到 Hyperledger Fabric</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting_started.html">入门指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="key_concepts.html">Key Concepts</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="tutorials.html">Tutorials - 教程</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="build_network.html">Building Your First Network - 构建你的第一个网络</a></li>
<li class="toctree-l3"><a class="reference internal" href="write_first_app.html">Writing Your First Application - 编写你的第一个应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="channel_update_tutorial.html">Adding an Org to a Channel</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Upgrading Your Network Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#launch-a-v1-0-6-network">Launch a v1.0.6 Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrade-the-orderer-containers">Upgrade the Orderer Containers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrade-the-peer-containers">Upgrade the Peer Containers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-capabilities-for-the-channels">Enable Capabilities for the Channels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-capabilities-on-existing-channels">Enabling Capabilities on Existing Channels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrading-components-byfn-does-not-support">Upgrading Components BYFN Does Not Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="chaincode.html">Chaincode Tutorials 链码指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="chaincode4ade.html">Chaincode for Developers</a></li>
<li class="toctree-l3"><a class="reference internal" href="chaincode4noah.html">Chaincode for Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemchaincode.html">System Chaincode Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="videos.html">Videos</a></li>
<li class="toctree-l3"><a class="reference internal" href="videos.html#id1">视频</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ops_guide.html">Operations Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">架构参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="Fabric-FAQ.html">Hyperledger Fabric FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="ordering-service-faq.html">Ordering Service FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l2"><a class="reference internal" href="glossary.html">Glossary - 词汇表</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="questions.html">Still Have Questions? - 依然遇到问题？</a></li>
<li class="toctree-l2"><a class="reference internal" href="status.html">Status - 状态</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">Key Concepts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials - 教程</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="build_network.html">Building Your First Network - 构建你的第一个网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="write_first_app.html">Writing Your First Application - 编写你的第一个应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="channel_update_tutorial.html">Adding an Org to a Channel</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Upgrading Your Network Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#launch-a-v1-0-6-network">Launch a v1.0.6 Network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clean-up">Clean up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-the-crypto-and-bring-up-the-network">Generate the Crypto and Bring Up the Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-the-newest-samples">Get the newest samples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#want-to-upgrade-now">Want to upgrade now?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade-the-orderer-containers">Upgrade the Orderer Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#upgrade-the-peer-containers">Upgrade the Peer Containers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#verify-upgrade-completion">Verify Upgrade Completion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enable-capabilities-for-the-channels">Enable Capabilities for the Channels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#orderer-system-channel-capabilities">Orderer System Channel Capabilities</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enabling-capabilities-on-existing-channels">Enabling Capabilities on Existing Channels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Orderer Group</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Channel Group</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-group">Application Group</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verify-that-capabilities-are-enabled">Verify that Capabilities are Enabled</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#upgrading-components-byfn-does-not-support">Upgrading Components BYFN Does Not Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fabric-ca-container">Fabric CA Container</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrade-node-sdk-clients">Upgrade Node SDK Clients</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrading-the-kafka-cluster">Upgrading the Kafka Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrading-couchdb">Upgrading CouchDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upgrade-chaincodes-with-vendored-shim">Upgrade Chaincodes With Vendored Shim</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="chaincode.html">Chaincode Tutorials 链码指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="chaincode4ade.html">Chaincode for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="chaincode4noah.html">Chaincode for Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="systemchaincode.html">System Chaincode Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="videos.html">Videos</a></li>
<li class="toctree-l2"><a class="reference internal" href="videos.html#id1">视频</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">Operations Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">架构参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">Hyperledger Fabric FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="ordering-service-faq.html">Ordering Service FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary - 词汇表</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">Still Have Questions? - 依然遇到问题？</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status - 状态</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials - 教程</a> &raquo;</li>
        
      <li>Upgrading Your Network Components</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/upgrading_your_network_tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="upgrading-your-network-components">
<h1>Upgrading Your Network Components<a class="headerlink" href="#upgrading-your-network-components" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When we use the term “upgrade” in this documentation, we’re primarily
referring to changing the version of a component (for example, going
from a v1.0.x binary to a v1.1 binary). The term “update,” on the other
hand, refers not to versions but to configuration changes, such as
updating a channel configuration or a deployment script.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Because the <a class="reference internal" href="build_network.html"><span class="doc">Building Your First Network - 构建你的第一个网络</span></a> (BYFN) tutorial defaults to the “latest” binaries, if
you have run it since the release of v1.1, your machine will have v1.1 binaries
and tools installed on it and you will not be able to upgrade them.</p>
<p>As a result, this tutorial will provide a network based on Hyperledger Fabric
v1.0.6 binaries as well as the v1.1 binaries you will be upgrading to. In addition,
we will show how to update channel configurations to recognize <a class="reference internal" href="capability_requirements.html"><span class="doc">Capability Requirements</span></a>.</p>
<p>However, because BYFN does not support the following components, our script for
upgrading BYFN will not cover them:</p>
<ul class="simple">
<li><strong>Fabric-CA</strong></li>
<li><strong>Kafka</strong></li>
<li><strong>SDK</strong></li>
</ul>
<p>The process for upgrading these components will be covered in a section following
the tutorial.</p>
<p>At a high level, our upgrade tutorial will perform the following steps:</p>
<ol class="arabic simple">
<li>Back up the ledger and MSPs.</li>
<li>Upgrade the orderer binaries to Fabric v1.1.</li>
<li>Upgrade the peer binaries to Fabric v1.1.</li>
<li>Enable v1.1 channel capability requirements.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In production environments, the orderers and peers can be upgraded
on a rolling basis simultaneously (in other words, you don’t need to
upgrade your orderers before upgrading your peers). Where extra care
must be taken is in enabling capabilities. All of the orderers and peers
must be upgraded before that step (if only some orderers have been
upgraded when capabilities have been enabled, a catastrophic state fork
can be created).</p>
</div>
<p>This tutorial will demonstrate how to perform each of these steps individually
with CLI commands.</p>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>If you haven’t already done so, ensure you have all of the dependencies on your
machine as described in <a class="reference internal" href="prereqs.html"><span class="doc">预备知识</span></a>.</p>
</div>
</div>
<div class="section" id="launch-a-v1-0-6-network">
<h2>Launch a v1.0.6 Network<a class="headerlink" href="#launch-a-v1-0-6-network" title="Permalink to this headline">¶</a></h2>
<p>To begin, we will provision a basic network running Fabric v1.0.6 images. This
network will consist of two organizations, each maintaining two peer nodes, and
a “solo” ordering service.</p>
<p>We will be operating from the <code class="docutils literal notranslate"><span class="pre">first-network</span></code> subdirectory within your local clone
of <code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code>. Change into that directory now. You will also want to open a
few extra terminals for ease of use.</p>
<div class="section" id="clean-up">
<h3>Clean up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h3>
<p>We want to operate from a known state, so we will use the <code class="docutils literal notranslate"><span class="pre">byfn.sh</span></code> script to
initially tidy up. This command will kill any active or stale docker containers
and remove any previously generated artifacts. Run the following command:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">byfn</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">m</span> <span class="n">down</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-the-crypto-and-bring-up-the-network">
<h3>Generate the Crypto and Bring Up the Network<a class="headerlink" href="#generate-the-crypto-and-bring-up-the-network" title="Permalink to this headline">¶</a></h3>
<p>With a clean environment, launch our v1.0.6 BYFN network using these four commands:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">fetch</span> <span class="n">origin</span>

<span class="n">git</span> <span class="n">checkout</span> <span class="n">v1</span><span class="o">.</span><span class="mf">0.6</span>

<span class="o">./</span><span class="n">byfn</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">m</span> <span class="n">generate</span>

<span class="o">./</span><span class="n">byfn</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">m</span> <span class="n">up</span> <span class="o">-</span><span class="n">t</span> <span class="mi">3000</span> <span class="o">-</span><span class="n">i</span> <span class="mf">1.0</span><span class="o">.</span><span class="mi">6</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have locally built v1.0.6 images, then they will be used by the example.
If you get errors, consider cleaning up v1.0.6 images and running the example
again. This will download 1.0.6 images from docker hub.</p>
</div>
<p>If BYFN has launched properly, you will see:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="n">All</span> <span class="n">GOOD</span><span class="p">,</span> <span class="n">BYFN</span> <span class="n">execution</span> <span class="n">completed</span> <span class="o">=====================</span>
</pre></div>
</div>
<p>We are now ready to upgrade our network to Hyperledger Fabric v1.1.</p>
</div>
<div class="section" id="get-the-newest-samples">
<h3>Get the newest samples<a class="headerlink" href="#get-the-newest-samples" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The instructions below pertain to whatever is the most recently
published version of v1.1.x, starting with 1.1.0-rc1. Please substitute
‘1.1.x’ with the version identifier of the published release that
you are testing. e.g. replace ‘v1.1.x’ with ‘v1.1.0’.</p>
</div>
<p>Before completing the rest of the tutorial, it’s important to get the v1.1.x
version of the samples, you can do this by:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">fetch</span> <span class="n">origin</span>

<span class="n">git</span> <span class="n">checkout</span> <span class="n">v1</span><span class="o">.</span><span class="mf">1.</span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="section" id="want-to-upgrade-now">
<h3>Want to upgrade now?<a class="headerlink" href="#want-to-upgrade-now" title="Permalink to this headline">¶</a></h3>
<p>We have a script that will upgrade all of the components in BYFN as well as
enabling capabilities. Afterwards, we will walk you through the steps
in the script and describe what each piece of code is doing in the upgrade process.</p>
<p>To run the script, issue these commands:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note, replace &#39;1.1.x&#39; with a specific version, for example &#39;1.1.0&#39;.</span>
<span class="c1"># Don&#39;t pass the image flag &#39;-i 1.1.x&#39; if you prefer to default to &#39;latest&#39; images.</span>

<span class="o">./</span><span class="n">byfn</span><span class="o">.</span><span class="n">sh</span> <span class="n">upgrade</span> <span class="o">-</span><span class="n">i</span> <span class="mf">1.1</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>If the upgrade is successful, you should see the following:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=====================</span> <span class="n">All</span> <span class="n">GOOD</span><span class="p">,</span> <span class="n">End</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">End</span> <span class="n">UPGRADE</span> <span class="n">Scenario</span> <span class="n">execution</span> <span class="n">completed</span> <span class="o">=====================</span>
</pre></div>
</div>
<p>if you want to upgrade the network manually, simply run <code class="docutils literal notranslate"><span class="pre">./byfn.sh</span> <span class="pre">-m</span> <span class="pre">down</span></code> again
and perform the steps up to – but not including – <code class="docutils literal notranslate"><span class="pre">./byfn.sh</span> <span class="pre">upgrade</span> <span class="pre">-i</span> <span class="pre">1.1.x</span></code>.
Then proceed to the next section.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Many of the commands you’ll run in this section will not result in any
output. In general, assume no output is good output.</p>
</div>
</div>
</div>
<div class="section" id="upgrade-the-orderer-containers">
<h2>Upgrade the Orderer Containers<a class="headerlink" href="#upgrade-the-orderer-containers" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pay <strong>CLOSE</strong> attention to your orderer upgrades. If they are not done
correctly – specifically, if only some orderers are upgraded and not
others – a state fork could be created (meaning, ledgers would no
longer be consistent). This MUST be avoided.</p>
</div>
<p>Orderer containers should be upgraded in a rolling fashion (one at a time). At a
high level, the orderer upgrade process goes as follows:</p>
<ol class="arabic simple">
<li>Stop the orderer.</li>
<li>Back up the orderer’s ledger and MSP.</li>
<li>Restart the orderer with the latest images.</li>
<li>Verify upgrade completion.</li>
</ol>
<p>As a consequence of leveraging BYFN, we have a solo orderer setup, therefore, we
will only perform this process once. In a Kafka setup, however, this process will
have to be performed for each orderer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This tutorial uses a docker deployment. For native deployments,
replace the file <code class="docutils literal notranslate"><span class="pre">orderer</span></code> with the one from the release artifacts.
Backup the <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code> and replace it with the <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code>
file from the release artifacts. Then port any modified variables from
the backed up <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code> to the new one. Utilizing a utility
like <code class="docutils literal notranslate"><span class="pre">diff</span></code> may be helpful. To decrease confusion, the variable
<code class="docutils literal notranslate"><span class="pre">General.TLS.ClientAuthEnabled</span></code> has been renamed to <code class="docutils literal notranslate"><span class="pre">General.TLS.ClientAuthRequired</span></code>
(just as it is specified in the peer configuration.). If the old name
for this variable is still present in the <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code> file, the
new <code class="docutils literal notranslate"><span class="pre">orderer</span></code> binary will fail to start.</p>
</div>
<p>Let’s begin the upgrade process by <strong>bringing down the orderer</strong>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>docker stop orderer.example.com

export LEDGERS_BACKUP=./ledgers-backup

# Note, replace &#39;1.1.x&#39; with a specific version, for example &#39;1.1.0&#39;.
# Set IMAGE_TAG to &#39;latest&#39; if you prefer to default to the images tagged &#39;latest&#39; on your system.

export IMAGE_TAG=`uname -m`-1.1.x
</pre></div>
</div>
<p>We have created a variable for a directory to put file backups into, and
exported the <code class="docutils literal notranslate"><span class="pre">IMAGE_TAG</span></code> we’d like to move to.</p>
<p>Once the orderer is down, you’ll want to <strong>backup its ledger and MSP</strong>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p $LEDGERS_BACKUP

docker cp orderer.example.com:/var/hyperledger/production/orderer/ ./$LEDGERS_BACKUP/orderer.example.com
</pre></div>
</div>
<p>In a production network this process would be repeated for each of the Kafka-based
orderers in a rolling fashion.</p>
<p>Now <strong>download and restart the orderer</strong> with our new fabric image:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">cli</span><span class="o">.</span><span class="n">yaml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>Because our sample uses a “solo” ordering service, there are no other orderers in the
network that the restarted orderer must sync up to. However, in a production network
leveraging Kafka, it will be a best practice to issue <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">&lt;blocknumber&gt;</span></code>
after restarting the orderer to verify that it has caught up to the other orderers.</p>
</div>
<div class="section" id="upgrade-the-peer-containers">
<h2>Upgrade the Peer Containers<a class="headerlink" href="#upgrade-the-peer-containers" title="Permalink to this headline">¶</a></h2>
<p>Next, let’s look at how to upgrade peer containers to Fabric v1.1. Peer containers should,
like the orderers, be upgraded in a rolling fashion (one at a time). As mentioned
during the orderer upgrade, orderers and peers may be upgraded in parallel, but for
the purposes of this tutorial we’ve separated the processes out. At a high level,
we will perform the following steps:</p>
<ol class="arabic simple">
<li>Stop the peer.</li>
<li>Back up the peer’s ledger and MSP.</li>
<li>Remove chaincode containers and images.</li>
<li>Restart the peer with with latest image.</li>
<li>Verify upgrade completion.</li>
</ol>
<p>We have four peers running in our network. We will perform this process once for
each peer, totaling four upgrades.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Again, this tutorial utilizes a docker deployment. For <strong>native</strong>
deployments, replace the file <code class="docutils literal notranslate"><span class="pre">peer</span></code> with the one from the release
artifacts. Backup your <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> and replace it with the one from
the release artifacts. Port any modified variables from the backed up
<code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> to the new one. Utilizing a utility like <code class="docutils literal notranslate"><span class="pre">diff</span></code> may be
helpful.</p>
</div>
<p>Let’s <strong>bring down the first peer</strong> with the following command:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>export PEER=peer0.org1.example.com

docker stop $PEER
</pre></div>
</div>
<p>We can then <strong>backup the peer’s ledger and MSP</strong>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p $LEDGERS_BACKUP

docker cp $PEER:/var/hyperledger/production ./$LEDGERS_BACKUP/$PEER
</pre></div>
</div>
<p>With the peer stopped and the ledger backed up, <strong>remove the peer chaincode
containers</strong>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>CC_CONTAINERS=$(docker ps | grep dev-$PEER | awk &#39;{print $1}&#39;)
if [ -n &quot;$CC_CONTAINERS&quot; ] ; then docker rm -f $CC_CONTAINERS ; fi
</pre></div>
</div>
<p>And the peer chaincode images:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>CC_IMAGES=$(docker images | grep dev-$PEER | awk &#39;{print $1}&#39;)
if [ -n &quot;$CC_IMAGES&quot; ] ; then docker rmi -f $CC_IMAGES ; fi
</pre></div>
</div>
<p>Now we’ll re-launch the peer using the v1.1 image tag:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>docker-compose -f docker-compose-cli.yaml up -d --no-deps $PEER
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although, BYFN supports using CouchDB, we opted for a simpler
implementation in this tutorial. If you are using CouchDB, however,
follow the instructions in the <strong>Upgrading CouchDB</strong> section below at
this time and then issue this command instead of the one above:</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>docker-compose -f docker-compose-cli.yaml -f docker-compose-couch.yaml up -d --no-deps $PEER
</pre></div>
</div>
<p>We’ll talk more generally about how to update CouchDB after the tutorial.</p>
<div class="section" id="verify-upgrade-completion">
<h3>Verify Upgrade Completion<a class="headerlink" href="#verify-upgrade-completion" title="Permalink to this headline">¶</a></h3>
<p>We’ve completed the upgrade for our first peer, but before we move on let’s check
to ensure the upgrade has been completed properly with a chaincode invoke. Let’s
move <code class="docutils literal notranslate"><span class="pre">10</span></code> from <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">b</span></code> using these commands:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">cli</span><span class="o">.</span><span class="n">yaml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="n">cli</span>

<span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">cli</span> <span class="n">bash</span>

<span class="n">peer</span> <span class="n">chaincode</span> <span class="n">invoke</span> <span class="o">-</span><span class="n">o</span> <span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7050</span>  <span class="o">--</span><span class="n">tls</span> <span class="o">--</span><span class="n">cafile</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">ordererOrganizations</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">orderers</span><span class="o">/</span><span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span><span class="o">/</span><span class="n">tlscacerts</span><span class="o">/</span><span class="n">tlsca</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>  <span class="o">-</span><span class="n">C</span> <span class="n">mychannel</span> <span class="o">-</span><span class="n">n</span> <span class="n">mycc</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;</span>
</pre></div>
</div>
<p>Our query earlier revealed a to have a value of <code class="docutils literal notranslate"><span class="pre">90</span></code> and we have just removed
<code class="docutils literal notranslate"><span class="pre">10</span></code> with our invoke. Therefore, a query against <code class="docutils literal notranslate"><span class="pre">a</span></code> should reveal <code class="docutils literal notranslate"><span class="pre">80</span></code>.
Let’s see:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span> <span class="n">chaincode</span> <span class="n">query</span> <span class="o">-</span><span class="n">C</span> <span class="n">mychannel</span> <span class="o">-</span><span class="n">n</span> <span class="n">mycc</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39;</span>
</pre></div>
</div>
<p>We should see the following:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Query</span> <span class="n">Result</span><span class="p">:</span> <span class="mi">80</span>
</pre></div>
</div>
<p>After verifying the peer was upgraded correctly, make sure to issue an <code class="docutils literal notranslate"><span class="pre">exit</span></code>
to leave the container before continuing to upgrade your peers. You can
do this by repeating the process above with a different peer name exported.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">PEER</span><span class="o">=</span><span class="n">peer1</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">export</span> <span class="n">PEER</span><span class="o">=</span><span class="n">peer0</span><span class="o">.</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">export</span> <span class="n">PEER</span><span class="o">=</span><span class="n">peer1</span><span class="o">.</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All peers must be upgraded BEFORE enabling capabilities.</p>
</div>
</div>
</div>
<div class="section" id="enable-capabilities-for-the-channels">
<h2>Enable Capabilities for the Channels<a class="headerlink" href="#enable-capabilities-for-the-channels" title="Permalink to this headline">¶</a></h2>
<p>Because v1.0.x Fabric binaries do not understand the concept of channel capabilities,
extra care must be taken when initially enabling capabilities for a channel.</p>
<p>Although Fabric binaries can and should be upgraded in a rolling fashion, <strong>it is
critical that the ordering admins not attempt to enable v1.1 capabilities until all
orderer binaries are at v1.1.x+</strong>. If any orderer is executing v1.0.x code, and
capabilities are enabled for a channel, the blockchain will fork as v1.0.x orderers
invalidate the change and v1.1.x+ orderers accept it. This is an exception for the
v1.0 to v1.1 upgrade. For future upgrades, such as v1.1 to v1.2, the ordering network
will handle the upgrade more gracefully and prevent the state fork.</p>
<p>In order to minimize the chance of a fork, attempts to enable the application or channel
v1.1 capabilities before enabling the orderer v1.1 capability will be rejected. Since the orderer
v1.1 capability can only be enabled by the ordering admins, making it a prerequisite for the
other capabilities prevents application admins from accidentally enabling capabilities before
the orderer is ready to support them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Once a capability has been enabled, disabling it is not recommended or
supported.</p>
</div>
<p>Once a capability has been enabled, it becomes part of the permanent record
for that channel. This means that even after disabling the capability, old binaries will
not be able to participate in the channel because they cannot process beyond the block
which enabled the capability to get to the block which disables it.</p>
<p>For this reason, think of enabling channel capabilities as a point of no return. Please
experiment with the new capabilities in a test setting and be confident before proceeding
to enable them in production.</p>
<p>Note that enabling capability requirements on a channel which a v1.0.0 peer is joined to
will result in a crash of the peer. This crashing behavior is deliberate because it
indicates a misconfiguration which might result in a state fork.</p>
<p>The error message displayed by failing v1.0.x peers will say:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Cannot</span> <span class="n">commit</span> <span class="n">block</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ledger</span> <span class="n">due</span> <span class="n">to</span> <span class="n">Error</span> <span class="n">validating</span> <span class="n">config</span> <span class="n">which</span> <span class="n">passed</span>
<span class="n">initial</span> <span class="n">validity</span> <span class="n">checks</span><span class="p">:</span> <span class="n">ConfigEnvelope</span> <span class="n">LastUpdate</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">produce</span> <span class="n">the</span> <span class="n">supplied</span>
<span class="n">config</span> <span class="n">result</span>
</pre></div>
</div>
<p>We will enable capabilities in the following order:</p>
<ol class="arabic simple">
<li>Orderer System Channel</li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li>Orderer Group</li>
<li>Channel Group</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Individual Channels</li>
</ol>
<blockquote>
<div><ol class="loweralpha simple">
<li>Orderer Group</li>
<li>Channel Group</li>
<li>Application Group</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to minimize the chance of a fork a best practice is to enable
the orderer system capability first and then enable individual channel
capabilities.</p>
</div>
<p>For each group, we will enable the capabilities in the following order:</p>
<ol class="arabic simple">
<li>Get the latest channel config</li>
<li>Create a modified channel config</li>
<li>Create a config update transaction</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This process will be accomplished through a series of config update
transactions, one for each channel group. In a real world production
network, these channel config updates would be handled by the admins
for each channel. Because BYFN all exists on a single machine, it is
possible for us to update each of these channels.</p>
</div>
<p>For more information on updating channel configs, click on <a class="reference internal" href="channel_update_tutorial.html"><span class="doc">Adding an Org to a Channel</span></a>
or the doc on <a class="reference internal" href="config_update.html"><span class="doc">Updating a Channel Configuration</span></a>.</p>
<p>Get back into the  <code class="docutils literal notranslate"><span class="pre">cli</span></code> container by reissuing <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">cli</span> <span class="pre">bash</span></code>.</p>
<p>Now let’s check the set environment variables with:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">|</span><span class="n">grep</span> <span class="n">PEER</span>
</pre></div>
</div>
<p>You’ll also need to install <code class="docutils literal notranslate"><span class="pre">jq</span></code>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>

<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">jq</span>
</pre></div>
</div>
<div class="section" id="orderer-system-channel-capabilities">
<h3>Orderer System Channel Capabilities<a class="headerlink" href="#orderer-system-channel-capabilities" title="Permalink to this headline">¶</a></h3>
<p>Let’s set our environment variables for the orderer system channel. Issue each of
these commands:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;OrdererMSP&quot;</span>

<span class="n">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">ordererOrganizations</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">orderers</span><span class="o">/</span><span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span><span class="o">/</span><span class="n">tlscacerts</span><span class="o">/</span><span class="n">tlsca</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>

<span class="n">CORE_PEER_MSPCONFIGPATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">ordererOrganizations</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">Admin</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span>

<span class="n">ORDERER_CA</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">ordererOrganizations</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">orderers</span><span class="o">/</span><span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span><span class="o">/</span><span class="n">tlscacerts</span><span class="o">/</span><span class="n">tlsca</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>And let’s set our channel name to <code class="docutils literal notranslate"><span class="pre">testchainid</span></code>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CH_NAME</span><span class="o">=</span><span class="n">testchainid</span>
</pre></div>
</div>
<div class="section" id="orderer-group">
<h4>Orderer Group<a class="headerlink" href="#orderer-group" title="Permalink to this headline">¶</a></h4>
<p>The first step in updating a channel configuration is getting the latest config
block:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CH_NAME  --tls --cafile $ORDERER_CA
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We require configtxlator v1.0.0 or higher for this next step.</p>
</div>
<p>To make our config easy to edit, let’s convert the config block to JSON using
configtxlator:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">configtxlator</span> <span class="n">proto_decode</span> <span class="o">--</span><span class="nb">input</span> <span class="n">config_block</span><span class="o">.</span><span class="n">pb</span> <span class="o">--</span><span class="nb">type</span> <span class="n">common</span><span class="o">.</span><span class="n">Block</span> <span class="o">--</span><span class="n">output</span> <span class="n">config_block</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>This command uses <code class="docutils literal notranslate"><span class="pre">jq</span></code> to remove the headers, metadata, and signatures
from the config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">config</span> <span class="n">config_block</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Next, add capabilities to the orderer group. The following command will create a
copy of the config file and add our new capabilities to it:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Orderer&quot;: {&quot;values&quot;: {&quot;Capabilities&quot;: .[1]}}}}}&#39;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">capabilities</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">modified_config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Note what we’re changing here: <code class="docutils literal notranslate"><span class="pre">Capabilities</span></code> are being added as a <code class="docutils literal notranslate"><span class="pre">value</span></code>
of the <code class="docutils literal notranslate"><span class="pre">orderer</span></code> group under <code class="docutils literal notranslate"><span class="pre">channel_group</span></code>. The specific channel we’re
working in is not noted in this command, but recall that it’s the orderer system
channel <code class="docutils literal notranslate"><span class="pre">testchainid</span></code>. It should be updated first because it is <strong>this</strong>
channel’s configuration that will be copied by default during the creation of
any new channel.</p>
<p>Now we can create the config update:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb

configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb

configtxlator compute_update --channel_id $CH_NAME --original config.pb --updated modified_config.pb --output config_update.pb
</pre></div>
</div>
<p>Package the config update into a transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json

echo &#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;$CH_NAME&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;$(cat config_update.json)&#39;}}}&#39; | jq . &gt; config_update_in_envelope.json

configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb
</pre></div>
</div>
<p>Submit the config update transaction:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The command below both signs and submits the transaction to the ordering
service.</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel update -f config_update_in_envelope.pb -c $CH_NAME -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA
</pre></div>
</div>
<p>Our config update transaction represents the difference between the original
config and the modified one, but the orderer will translate this into a full
channel config.</p>
</div>
<div class="section" id="channel-group">
<h4>Channel Group<a class="headerlink" href="#channel-group" title="Permalink to this headline">¶</a></h4>
<p>Now let’s move on to enabling capabilities for the channel group at the orderer
system level.</p>
<p>The first step, as before, is to get the latest channel configuration.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This set of commands is exactly the same as the steps from the orderer
group.</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CH_NAME --tls --cafile $ORDERER_CA

configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json

jq .data.data[0].payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>Next, create a modified channel config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;values&quot;: {&quot;Capabilities&quot;: .[1]}}}&#39;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">capabilities</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">modified_config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Note what we’re changing here: <code class="docutils literal notranslate"><span class="pre">Capabilities</span></code> are being added as a <code class="docutils literal notranslate"><span class="pre">value</span></code> of
the top level <code class="docutils literal notranslate"><span class="pre">channel_group</span></code> (in the <code class="docutils literal notranslate"><span class="pre">testchainid</span></code> channel, as before).</p>
<p>Create the config update transaction:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This set of commands is exactly the same as the third step from the
orderer group.</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb

configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb

configtxlator compute_update --channel_id $CH_NAME --original config.pb --updated modified_config.pb --output config_update.pb
</pre></div>
</div>
<p>Package the config update into a transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json

echo &#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;$CH_NAME&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;$(cat config_update.json)&#39;}}}&#39; | jq . &gt; config_update_in_envelope.json

configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb
</pre></div>
</div>
<p>Submit the config update transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel update -f config_update_in_envelope.pb -c $CH_NAME -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="enabling-capabilities-on-existing-channels">
<h2>Enabling Capabilities on Existing Channels<a class="headerlink" href="#enabling-capabilities-on-existing-channels" title="Permalink to this headline">¶</a></h2>
<p>Set the channel name to <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CH_NAME</span><span class="o">=</span><span class="n">mychannel</span>
</pre></div>
</div>
<div class="section" id="id1">
<h3>Orderer Group<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Get the channel config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CH_NAME  --tls --cafile $ORDERER_CA

configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json

jq .data.data[0].payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>Let’s add capabilities to the orderer group. The following command will create a
copy of the config file and add our new capabilities to it:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Orderer&quot;: {&quot;values&quot;: {&quot;Capabilities&quot;: .[1]}}}}}&#39;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">capabilities</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">modified_config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Note what we’re changing here: <code class="docutils literal notranslate"><span class="pre">Capabilities</span></code> are being added as a <code class="docutils literal notranslate"><span class="pre">value</span></code>
of the <code class="docutils literal notranslate"><span class="pre">orderer</span></code> group under <code class="docutils literal notranslate"><span class="pre">channel_group</span></code>. This is exactly what we changed
before, only now we’re working with the config to the channel <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">testchainid</span></code>.</p>
<p>Create the config update:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb

configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb

configtxlator compute_update --channel_id $CH_NAME --original config.pb --updated modified_config.pb --output config_update.pb
</pre></div>
</div>
<p>Package the config update into a transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json

echo &#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;$CH_NAME&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;$(cat config_update.json)&#39;}}}&#39; | jq . &gt; config_update_in_envelope.json

configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb
</pre></div>
</div>
<p>Submit the config update transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel update -f config_update_in_envelope.pb -c $CH_NAME -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Channel Group<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While this may seem repetitive, remember that we’re performing the same
process on different groups. In a production network, as we’ve said,
this process would likely be split up among the various channel admins.</p>
</div>
<p>Fetch, decode, and scope the config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CH_NAME --tls --cafile $ORDERER_CA

configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json

jq .data.data[0].payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>Create a modified config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;values&quot;: {&quot;Capabilities&quot;: .[1]}}}&#39;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">capabilities</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">modified_config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Note what we’re changing here: <code class="docutils literal notranslate"><span class="pre">Capabilities</span></code> are being added as a <code class="docutils literal notranslate"><span class="pre">value</span></code>
of the top level <code class="docutils literal notranslate"><span class="pre">channel_group</span></code> (in <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>, as before).</p>
<p>Create the config update:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb

configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb

configtxlator compute_update --channel_id $CH_NAME --original config.pb --updated modified_config.pb --output config_update.pb
</pre></div>
</div>
<p>Package the config update into a transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json

echo &#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;$CH_NAME&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;$(cat config_update.json)&#39;}}}&#39; | jq . &gt; config_update_in_envelope.json

configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb
</pre></div>
</div>
<p>Because we’re updating the config of the <code class="docutils literal notranslate"><span class="pre">channel</span></code> group, the relevant orgs –
Org1, Org2, and the OrdererOrg – need to sign it. This task would usually
be performed by the individual org admins, but in BYFN, as we’ve said, this task
falls to us.</p>
<p>First, switch into Org1 and sign the update:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org1MSP&quot;</span>

<span class="n">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">peers</span><span class="o">/</span><span class="n">peer0</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>

<span class="n">CORE_PEER_MSPCONFIGPATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">Admin</span><span class="nd">@org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span>

<span class="n">CORE_PEER_ADDRESS</span><span class="o">=</span><span class="n">peer0</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7051</span>

<span class="n">peer</span> <span class="n">channel</span> <span class="n">signconfigtx</span> <span class="o">-</span><span class="n">f</span> <span class="n">config_update_in_envelope</span><span class="o">.</span><span class="n">pb</span>
</pre></div>
</div>
<p>And do the same as Org2:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org2MSP&quot;</span>

<span class="n">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">peers</span><span class="o">/</span><span class="n">peer0</span><span class="o">.</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>

<span class="n">CORE_PEER_MSPCONFIGPATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">Admin</span><span class="nd">@org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span>

<span class="n">CORE_PEER_ADDRESS</span><span class="o">=</span><span class="n">peer0</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7051</span>

<span class="n">peer</span> <span class="n">channel</span> <span class="n">signconfigtx</span> <span class="o">-</span><span class="n">f</span> <span class="n">config_update_in_envelope</span><span class="o">.</span><span class="n">pb</span>
</pre></div>
</div>
<p>And as the OrdererOrg:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>CORE_PEER_LOCALMSPID=&quot;OrdererMSP&quot;

CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/users/Admin@example.com/msp

peer channel update -f config_update_in_envelope.pb -c $CH_NAME -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA
</pre></div>
</div>
</div>
<div class="section" id="application-group">
<h3>Application Group<a class="headerlink" href="#application-group" title="Permalink to this headline">¶</a></h3>
<p>For the application group, we will need to reset the environment variables as
one organization:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org1MSP&quot;</span>

<span class="n">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">peers</span><span class="o">/</span><span class="n">peer0</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>

<span class="n">CORE_PEER_MSPCONFIGPATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">Admin</span><span class="nd">@org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span>

<span class="n">CORE_PEER_ADDRESS</span><span class="o">=</span><span class="n">peer0</span><span class="o">.</span><span class="n">org1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7051</span>
</pre></div>
</div>
<p>Now, get the latest channel config (this process should be very familiar by now):</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c $CH_NAME --tls --cafile $ORDERER_CA

configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json

jq .data.data[0].payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>Create a modified channel config:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Application&quot;: {&quot;values&quot;: {&quot;Capabilities&quot;: .[1]}}}}}&#39;</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">capabilities</span><span class="o">.</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">modified_config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Note what we’re changing here: <code class="docutils literal notranslate"><span class="pre">Capabilities</span></code> are being added as a <code class="docutils literal notranslate"><span class="pre">value</span></code>
of the <code class="docutils literal notranslate"><span class="pre">Application</span></code> group under <code class="docutils literal notranslate"><span class="pre">channel_group</span></code> (in <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>).</p>
<p>Create a config update transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb

configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb

configtxlator compute_update --channel_id $CH_NAME --original config.pb --updated modified_config.pb --output config_update.pb
</pre></div>
</div>
<p>Package the config update into a transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json

echo &#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;$CH_NAME&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;$(cat config_update.json)&#39;}}}&#39; | jq . &gt; config_update_in_envelope.json

configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output config_update_in_envelope.pb
</pre></div>
</div>
<p>Org1 signs the transaction:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span> <span class="n">channel</span> <span class="n">signconfigtx</span> <span class="o">-</span><span class="n">f</span> <span class="n">config_update_in_envelope</span><span class="o">.</span><span class="n">pb</span>
</pre></div>
</div>
<p>Set the environment variables as Org2:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org2MSP&quot;</span>

<span class="n">export</span> <span class="n">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">peers</span><span class="o">/</span><span class="n">peer0</span><span class="o">.</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>

<span class="n">export</span> <span class="n">CORE_PEER_MSPCONFIGPATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">peerOrganizations</span><span class="o">/</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">Admin</span><span class="nd">@org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span>

<span class="n">export</span> <span class="n">CORE_PEER_ADDRESS</span><span class="o">=</span><span class="n">peer0</span><span class="o">.</span><span class="n">org2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7051</span>
</pre></div>
</div>
<p>Org2 submits the config update transaction with its signature:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>peer channel update -f config_update_in_envelope.pb -c $CH_NAME -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA
</pre></div>
</div>
<p>Congratulations! You have now enabled capabilities on all of your channels.</p>
</div>
<div class="section" id="verify-that-capabilities-are-enabled">
<h3>Verify that Capabilities are Enabled<a class="headerlink" href="#verify-that-capabilities-are-enabled" title="Permalink to this headline">¶</a></h3>
<p>But let’s test just to make sure by moving <code class="docutils literal notranslate"><span class="pre">10</span></code> from <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">b</span></code>, as before:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span> <span class="n">chaincode</span> <span class="n">invoke</span> <span class="o">-</span><span class="n">o</span> <span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">7050</span>  <span class="o">--</span><span class="n">tls</span> <span class="o">--</span><span class="n">cafile</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gopath</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hyperledger</span><span class="o">/</span><span class="n">fabric</span><span class="o">/</span><span class="n">peer</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">ordererOrganizations</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">orderers</span><span class="o">/</span><span class="n">orderer</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">msp</span><span class="o">/</span><span class="n">tlscacerts</span><span class="o">/</span><span class="n">tlsca</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>  <span class="o">-</span><span class="n">C</span> <span class="n">mychannel</span> <span class="o">-</span><span class="n">n</span> <span class="n">mycc</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;</span>
</pre></div>
</div>
<p>And then querying the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>, which should reveal a value of <code class="docutils literal notranslate"><span class="pre">70</span></code>.
Let’s see:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span> <span class="n">chaincode</span> <span class="n">query</span> <span class="o">-</span><span class="n">C</span> <span class="n">mychannel</span> <span class="o">-</span><span class="n">n</span> <span class="n">mycc</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39;</span>
</pre></div>
</div>
<p>We should see the following:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Query</span> <span class="n">Result</span><span class="p">:</span> <span class="mi">70</span>
</pre></div>
</div>
<p>In which case we have successfully added capabilities to all of our channels.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although all peer binaries in the network should have been upgraded
prior to this point, enabling capability requirements on a channel
which a v1.0.0 peer is joined to will result in a crash of the peer.
This crashing behavior is deliberate because it indicates a
misconfiguration which might result in a state fork.</p>
</div>
</div>
</div>
<div class="section" id="upgrading-components-byfn-does-not-support">
<h2>Upgrading Components BYFN Does Not Support<a class="headerlink" href="#upgrading-components-byfn-does-not-support" title="Permalink to this headline">¶</a></h2>
<p>Although this is the end of our update tutorial, there are other components that
exist in production networks that are not supported by the BYFN sample. In this
section, we’ll talk through the process of updating them.</p>
<div class="section" id="fabric-ca-container">
<h3>Fabric CA Container<a class="headerlink" href="#fabric-ca-container" title="Permalink to this headline">¶</a></h3>
<p>To learn how to upgrade your Fabric CA server, click over to the <a class="reference external" href="http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html#upgrading-the-server">CA documentation.</a></p>
</div>
<div class="section" id="upgrade-node-sdk-clients">
<h3>Upgrade Node SDK Clients<a class="headerlink" href="#upgrade-node-sdk-clients" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Upgrade Fabric CA before upgrading Node SDK Clients.</p>
</div>
<p>Use NPM to upgrade any <code class="docutils literal notranslate"><span class="pre">Node.js</span></code> client by executing these commands in the
root directory of your application:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="n">fabric</span><span class="o">-</span><span class="n">client</span><span class="nd">@1</span><span class="o">.</span><span class="mi">1</span>

<span class="n">npm</span> <span class="n">install</span> <span class="n">fabric</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">client</span><span class="nd">@1</span><span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
<p>These commands install the new version of both the Fabric client and Fabric-CA
client and write the new versions <code class="docutils literal notranslate"><span class="pre">package.json</span></code>.</p>
</div>
<div class="section" id="upgrading-the-kafka-cluster">
<h3>Upgrading the Kafka Cluster<a class="headerlink" href="#upgrading-the-kafka-cluster" title="Permalink to this headline">¶</a></h3>
<p>It is not required, but it is recommended that the Kafka cluster be upgraded and
kept up to date along with the rest of Fabric. Newer versions of Kafka support
older protocol versions, so you may upgrade Kafka before or after the rest of
Fabric.</p>
<p>If your Kafka cluster is older than Kafka v0.11.0, this upgrade is especially
recommended as it hardens replication in order to better handle crash faults.</p>
<p>Refer to the official Apache Kafka documentation on <a class="reference external" href="https://kafka.apache.org/documentation/#upgrade">upgrading Kafka from previous
versions</a> to upgrade the Kafka cluster brokers.</p>
<p>Please note that the Kafka cluster might experience a negative performance impact
if the orderer is configured to use a Kafka protocol version that is older than
the Kafka broker version. The Kafka protocol version is set using either the
<code class="docutils literal notranslate"><span class="pre">Kafka.Version</span></code> key in the <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code> file or via the <code class="docutils literal notranslate"><span class="pre">ORDERER_KAFKA_VERSION</span></code>
environment variable in a Docker deployment. Fabric v1.0 provided sample Kafka
docker images containing Kafka version 0.9.0.1. Fabric v1.1 provides
sample Kafka docker images containing Kafka version v1.0.0.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You must configure the Kafka protocol version used by the orderer to
match your Kafka cluster version, even if it was not set before. For
example, if you are using the sample Kafka images provided with
Fabric v1.0.x, either set the <code class="docutils literal notranslate"><span class="pre">ORDERER_KAFKA_VERSION</span></code> environment
variable, or the <code class="docutils literal notranslate"><span class="pre">Kafka.Version</span></code> key in the <code class="docutils literal notranslate"><span class="pre">orderer.yaml</span></code> to
<code class="docutils literal notranslate"><span class="pre">0.9.0.1</span></code>. If you are unsure about your Kafka cluster version, you
can configure the orderer’s Kafka protocol version to <code class="docutils literal notranslate"><span class="pre">0.9.0.1</span></code> for
maximum compatibility and update the setting afterwards when you have
determined your Kafka cluster version.</p>
</div>
<div class="section" id="upgrading-zookeeper">
<h4>Upgrading Zookeeper<a class="headerlink" href="#upgrading-zookeeper" title="Permalink to this headline">¶</a></h4>
<p>An Apache Kafka cluster requires an Apache Zookeeper cluster. The Zookeeper API
has been stable for a long time and, as such, almost any version of Zookeeper is
tolerated by Kafka. Refer to the <a class="reference external" href="https://kafka.apache.org/documentation/#upgrade">Apache Kafka upgrade</a> documentation in case
there is a specific requirement to upgrade to a specific version of Zookeeper.
If you would like to upgrade your Zookeeper cluster, some information on
upgrading Zookeeper cluster can be found in the <a class="reference external" href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/FAQ">Zookeeper FAQ</a>.</p>
</div>
</div>
<div class="section" id="upgrading-couchdb">
<h3>Upgrading CouchDB<a class="headerlink" href="#upgrading-couchdb" title="Permalink to this headline">¶</a></h3>
<p>If you are using CouchDB as state database, upgrade the peer’s CouchDB at the same
time the peer is being upgraded. To upgrade CouchDB:</p>
<ol class="arabic simple">
<li>Stop CouchDB.</li>
<li>Backup CouchDB data directory.</li>
<li>Delete CouchDB data directory.</li>
<li>Install CouchDB v2.1.1 binaries or update deployment scripts to use a new Docker image
(CouchDB v2.1.1 pre-configured Docker image is provided alongside Fabric v1.1).</li>
<li>Restart CouchDB.</li>
</ol>
<p>The reason to delete the CouchDB data directory is that upon startup the v1.1 peer
will rebuild the CouchDB state databases from the blockchain transactions. Starting
in v1.1, there will be an internal CouchDB database for each <code class="docutils literal notranslate"><span class="pre">channel_chaincode</span></code>
combination (for each chaincode instantiated on each channel that the peer has joined).</p>
</div>
<div class="section" id="upgrade-chaincodes-with-vendored-shim">
<h3>Upgrade Chaincodes With Vendored Shim<a class="headerlink" href="#upgrade-chaincodes-with-vendored-shim" title="Permalink to this headline">¶</a></h3>
<p>A number of third party tools exist that will allow you to vendor a chaincode
shim. If you used one of these tools, use the same one to update your vendoring
and re-package your chaincode.</p>
<p>If your chaincode vendors the shim, after updating the shim version, you must install
it to all peers which already have the chaincode. Install it with the same name, but
a newer version. Then you should execute a chaincode upgrade on each channel where
this chaincode has been deployed to move to the new version.</p>
<p>If you did not vendor your chaincode, you can skip this step entirely.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="chaincode.html" class="btn btn-neutral float-right" title="Chaincode Tutorials 链码指南" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="channel_update_tutorial.html" class="btn btn-neutral" title="Adding an Org to a Channel" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'master',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>